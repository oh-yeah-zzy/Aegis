{% extends "base.html" %}

{% block content %}
<div class="audit-page">
    <h1>审计日志</h1>

    <div class="card">
        <div class="card-header">
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="search-path" placeholder="搜索路径...">
                    <select id="filter-decision">
                        <option value="">全部决策</option>
                        <option value="allow">允许</option>
                        <option value="deny">拒绝</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="loadAuditLogs()">刷新</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>请求ID</th>
                            <th>用户</th>
                            <th>客户端IP</th>
                            <th>方法</th>
                            <th>路径</th>
                            <th>状态码</th>
                            <th>延迟</th>
                            <th>决策</th>
                            <th>原因</th>
                        </tr>
                    </thead>
                    <tbody id="audit-table">
                        <tr>
                            <td colspan="10" class="empty-state">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    const pageSize = 20;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadAuditLogs();

        document.getElementById('search-path').addEventListener('input', debounce(loadAuditLogs, 300));
        document.getElementById('filter-decision').addEventListener('change', loadAuditLogs);
    });

    async function loadAuditLogs() {
        const path = document.getElementById('search-path').value;
        const decision = document.getElementById('filter-decision').value;

        // 修正：使用正确的 API 路径 /api/v1/audit/logs，参数使用 page/page_size
        let url = `/api/v1/audit/logs?page=${currentPage}&page_size=${pageSize}`;
        if (path) url += `&path=${encodeURIComponent(path)}`;
        if (decision) url += `&decision=${decision}`;

        try {
            const response = await fetchWithAuth(url);
            const tbody = document.getElementById('audit-table');

            if (response.ok) {
                const data = await response.json();
                // 修正：后端返回 {items: [], total, page, page_size} 格式
                const logs = Array.isArray(data) ? data : (data.items || []);

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="empty-state">暂无审计日志</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${formatTime(log.ts)}</td>
                        <td title="${log.request_id}">${log.request_id?.substring(0, 8) || '-'}...</td>
                        <td>${log.principal_label || log.principal_type || '-'}</td>
                        <td>${log.client_ip || '-'}</td>
                        <td><span class="badge badge-info">${log.method}</span></td>
                        <td title="${log.path}">${truncate(log.path, 30)}</td>
                        <td><span class="badge ${getStatusBadge(log.status_code)}">${log.status_code}</span></td>
                        <td>${log.latency_ms || 0}ms</td>
                        <td><span class="badge ${log.decision === 'allow' ? 'badge-success' : 'badge-danger'}">${log.decision}</span></td>
                        <td title="${log.deny_reason || ''}">${truncate(log.deny_reason || '-', 20)}</td>
                    </tr>
                `).join('');

                // 更新分页信息（如果后端返回了 total）
                if (data.total !== undefined) {
                    updatePagination(data.total, data.page, data.page_size);
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">加载失败</td></tr>';
            }
        } catch (error) {
            console.error('加载审计日志失败:', error);
            document.getElementById('audit-table').innerHTML = '<tr><td colspan="10" class="empty-state">加载失败</td></tr>';
        }
    }

    // 更新分页控件
    function updatePagination(total, page, pageSize) {
        const totalPages = Math.ceil(total / pageSize);
        const paginationDiv = document.getElementById('pagination');

        if (totalPages <= 1) {
            paginationDiv.innerHTML = '';
            return;
        }

        let html = '';
        if (page > 1) {
            html += `<button onclick="goToPage(${page - 1})">&laquo; 上一页</button>`;
        }
        html += `<span>第 ${page} / ${totalPages} 页 (共 ${total} 条)</span>`;
        if (page < totalPages) {
            html += `<button onclick="goToPage(${page + 1})">下一页 &raquo;</button>`;
        }
        paginationDiv.innerHTML = html;
    }

    // 跳转到指定页
    function goToPage(page) {
        currentPage = page;
        loadAuditLogs();
    }

    function getStatusBadge(code) {
        if (code >= 200 && code < 300) return 'badge-success';
        if (code >= 400 && code < 500) return 'badge-warning';
        return 'badge-danger';
    }

    function formatTime(timestamp) {
        if (!timestamp) return '-';
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN');
    }

    function truncate(str, len) {
        if (!str) return '-';
        return str.length > len ? str.substring(0, len) + '...' : str;
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
</script>
{% endblock %}
