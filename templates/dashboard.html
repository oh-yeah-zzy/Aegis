{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <h1>ä»ªè¡¨ç›˜</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon users">ğŸ‘¤</div>
            <div class="stat-info">
                <h3 id="user-count">-</h3>
                <p>ç”¨æˆ·æ€»æ•°</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon roles">ğŸ­</div>
            <div class="stat-info">
                <h3 id="role-count">-</h3>
                <p>è§’è‰²æ€»æ•°</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon policies">ğŸ”</div>
            <div class="stat-info">
                <h3 id="policy-count">-</h3>
                <p>è®¤è¯ç­–ç•¥</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon requests">ğŸ“Š</div>
            <div class="stat-info">
                <h3 id="request-count">-</h3>
                <p>ä»Šæ—¥è¯·æ±‚</p>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>æœ€è¿‘å®¡è®¡æ—¥å¿—</h2>
            <a href="/admin/audit" class="btn btn-sm btn-primary">æŸ¥çœ‹å…¨éƒ¨</a>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>ç”¨æˆ·</th>
                            <th>æ–¹æ³•</th>
                            <th>è·¯å¾„</th>
                            <th>çŠ¶æ€ç </th>
                            <th>å†³ç­–</th>
                        </tr>
                    </thead>
                    <tbody id="audit-logs">
                        <tr>
                            <td colspan="6" class="empty-state">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        await loadStats();
        await loadRecentAuditLogs();
    });

    async function loadStats() {
        try {
            // åŠ è½½ç”¨æˆ·æ•°é‡
            const usersRes = await fetchWithAuth('/api/v1/users');
            if (usersRes.ok) {
                const users = await usersRes.json();
                document.getElementById('user-count').textContent = users.length;
            }

            // åŠ è½½è§’è‰²æ•°é‡
            const rolesRes = await fetchWithAuth('/api/v1/roles');
            if (rolesRes.ok) {
                const roles = await rolesRes.json();
                document.getElementById('role-count').textContent = roles.length;
            }

            // åŠ è½½ç­–ç•¥æ•°é‡ï¼ˆç®€å•ä¼°è®¡ï¼‰
            document.getElementById('policy-count').textContent = '-';

            // åŠ è½½ä»Šæ—¥è¯·æ±‚æ•°é‡
            document.getElementById('request-count').textContent = '-';

        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
        }
    }

    async function loadRecentAuditLogs() {
        try {
            // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¡®çš„ API è·¯å¾„å’Œå‚æ•°
            const response = await fetchWithAuth('/api/v1/audit/logs?page=1&page_size=10');
            const tbody = document.getElementById('audit-logs');

            if (response.ok) {
                const data = await response.json();
                // ä¿®æ­£ï¼šä» data.items è·å–æ—¥å¿—æ•°ç»„
                const logs = Array.isArray(data) ? data : (data.items || []);

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— å®¡è®¡æ—¥å¿—</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${formatTime(log.ts)}</td>
                        <td>${log.principal_label || log.principal_type || '-'}</td>
                        <td>${log.method}</td>
                        <td>${log.path}</td>
                        <td><span class="badge ${getStatusBadge(log.status_code)}">${log.status_code}</span></td>
                        <td><span class="badge ${log.decision === 'allow' ? 'badge-success' : 'badge-danger'}">${log.decision}</span></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">åŠ è½½å¤±è´¥</td></tr>';
            }
        } catch (error) {
            console.error('åŠ è½½å®¡è®¡æ—¥å¿—å¤±è´¥:', error);
            document.getElementById('audit-logs').innerHTML = '<tr><td colspan="6" class="empty-state">åŠ è½½å¤±è´¥</td></tr>';
        }
    }

    function getStatusBadge(code) {
        if (code >= 200 && code < 300) return 'badge-success';
        if (code >= 400 && code < 500) return 'badge-warning';
        return 'badge-danger';
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN');
    }
</script>
{% endblock %}
