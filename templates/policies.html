{% extends "base.html" %}

{% block content %}
<div class="policies-page">
    <h1>认证策略管理</h1>

    <div class="card">
        <div class="card-header">
            <h2>认证策略列表</h2>
            <button class="btn btn-primary" onclick="showAddPolicyModal()">+ 添加策略</button>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>名称</th>
                            <th>路径模式</th>
                            <th>优先级</th>
                            <th>需要认证</th>
                            <th>需要S2S</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="policies-table">
                        <tr>
                            <td colspan="8" class="empty-state">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
            <h2>路径模式说明</h2>
        </div>
        <div class="card-body">
            <table>
                <thead>
                    <tr>
                        <th>模式</th>
                        <th>说明</th>
                        <th>匹配示例</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/**</code></td>
                        <td>匹配所有路径</td>
                        <td>/any/path, /a/b/c</td>
                    </tr>
                    <tr>
                        <td><code>/prefix/**</code></td>
                        <td>匹配指定前缀的所有路径</td>
                        <td>/prefix/any, /prefix/a/b</td>
                    </tr>
                    <tr>
                        <td><code>/prefix-*/**</code></td>
                        <td>匹配前缀+通配符</td>
                        <td>/prefix-abc/x, /prefix-123/y</td>
                    </tr>
                    <tr>
                        <td><code>/exact/path</code></td>
                        <td>精确匹配</td>
                        <td>仅匹配 /exact/path</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 添加策略模态框 -->
<div id="add-policy-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>添加认证策略</h3>
            <button class="modal-close" onclick="closeModal('add-policy-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="add-policy-form">
                <div class="form-group">
                    <label for="new-name">策略名称</label>
                    <input type="text" id="new-name" required placeholder="如：公开接口">
                </div>
                <div class="form-group">
                    <label for="new-path-pattern">路径模式</label>
                    <input type="text" id="new-path-pattern" required placeholder="如：/public/**">
                </div>
                <div class="form-group">
                    <label for="new-priority">优先级（数字越大越优先）</label>
                    <input type="number" id="new-priority" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="new-auth-required" checked>
                        需要用户认证
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="new-s2s-required">
                        需要服务间认证
                    </label>
                </div>
                <div class="form-group">
                    <label for="new-description">描述</label>
                    <textarea id="new-description" rows="2" style="width:100%;padding:0.5rem;"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('add-policy-modal')">取消</button>
            <button class="btn btn-primary" onclick="addPolicy()">添加</button>
        </div>
    </div>
</div>

<!-- 编辑策略模态框 -->
<div id="edit-policy-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>编辑认证策略</h3>
            <button class="modal-close" onclick="closeModal('edit-policy-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-policy-form">
                <input type="hidden" id="edit-policy-id">
                <div class="form-group">
                    <label for="edit-name">策略名称</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-path-pattern">路径模式</label>
                    <input type="text" id="edit-path-pattern" required>
                </div>
                <div class="form-group">
                    <label for="edit-priority">优先级</label>
                    <input type="number" id="edit-priority" min="0">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="edit-auth-required">
                        需要用户认证
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="edit-s2s-required">
                        需要服务间认证
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="edit-enabled">
                        启用
                    </label>
                </div>
                <div class="form-group">
                    <label for="edit-description">描述</label>
                    <textarea id="edit-description" rows="2" style="width:100%;padding:0.5rem;"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('edit-policy-modal')">取消</button>
            <button class="btn btn-primary" onclick="updatePolicy()">保存</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allPolicies = [];

    document.addEventListener('DOMContentLoaded', async () => {
        await loadPolicies();
    });

    async function loadPolicies() {
        try {
            const response = await fetchWithAuth('/api/v1/auth-policies');
            if (response.ok) {
                allPolicies = await response.json();
                renderPolicies(allPolicies);
            } else {
                // 如果API不存在，显示空状态
                document.getElementById('policies-table').innerHTML =
                    '<tr><td colspan="8" class="empty-state">暂无认证策略</td></tr>';
            }
        } catch (error) {
            console.error('加载策略失败:', error);
            document.getElementById('policies-table').innerHTML =
                '<tr><td colspan="8" class="empty-state">加载失败</td></tr>';
        }
    }

    function renderPolicies(policies) {
        const tbody = document.getElementById('policies-table');

        if (policies.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-state">暂无认证策略</td></tr>';
            return;
        }

        tbody.innerHTML = policies.map(policy => `
            <tr>
                <td>${policy.id}</td>
                <td>${policy.name}</td>
                <td><code>${policy.path_pattern}</code></td>
                <td>${policy.priority}</td>
                <td>${policy.auth_required ? '<span class="badge badge-info">是</span>' : '否'}</td>
                <td>${policy.s2s_required ? '<span class="badge badge-info">是</span>' : '否'}</td>
                <td>
                    <label class="switch">
                        <input type="checkbox" ${policy.enabled ? 'checked' : ''} onchange="togglePolicy(${policy.id}, this.checked)">
                        <span class="slider"></span>
                    </label>
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="showEditPolicyModal(${policy.id})">编辑</button>
                    <button class="btn btn-sm btn-danger" onclick="deletePolicy(${policy.id})">删除</button>
                </td>
            </tr>
        `).join('');
    }

    function showAddPolicyModal() {
        document.getElementById('add-policy-form').reset();
        document.getElementById('new-auth-required').checked = true;
        document.getElementById('add-policy-modal').classList.add('active');
    }

    function showEditPolicyModal(policyId) {
        const policy = allPolicies.find(p => p.id === policyId);
        if (!policy) return;

        document.getElementById('edit-policy-id').value = policy.id;
        document.getElementById('edit-name').value = policy.name;
        document.getElementById('edit-path-pattern').value = policy.path_pattern;
        document.getElementById('edit-priority').value = policy.priority;
        document.getElementById('edit-auth-required').checked = policy.auth_required;
        document.getElementById('edit-s2s-required').checked = policy.s2s_required;
        document.getElementById('edit-enabled').checked = policy.enabled;
        document.getElementById('edit-description').value = policy.description || '';
        document.getElementById('edit-policy-modal').classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    async function addPolicy() {
        const data = {
            name: document.getElementById('new-name').value,
            path_pattern: document.getElementById('new-path-pattern').value,
            priority: parseInt(document.getElementById('new-priority').value) || 0,
            auth_required: document.getElementById('new-auth-required').checked,
            s2s_required: document.getElementById('new-s2s-required').checked,
            description: document.getElementById('new-description').value,
            enabled: true,
        };

        try {
            const response = await fetchWithAuth('/api/v1/auth-policies', {
                method: 'POST',
                body: JSON.stringify(data),
            });

            if (response.ok) {
                closeModal('add-policy-modal');
                await loadPolicies();
                alert('策略添加成功');
            } else {
                const res = await response.json();
                alert(res.detail || '添加失败');
            }
        } catch (error) {
            alert('添加失败: ' + error.message);
        }
    }

    async function updatePolicy() {
        const policyId = document.getElementById('edit-policy-id').value;
        const data = {
            name: document.getElementById('edit-name').value,
            path_pattern: document.getElementById('edit-path-pattern').value,
            priority: parseInt(document.getElementById('edit-priority').value) || 0,
            auth_required: document.getElementById('edit-auth-required').checked,
            s2s_required: document.getElementById('edit-s2s-required').checked,
            enabled: document.getElementById('edit-enabled').checked,
            description: document.getElementById('edit-description').value,
        };

        try {
            const response = await fetchWithAuth(`/api/v1/auth-policies/${policyId}`, {
                method: 'PUT',
                body: JSON.stringify(data),
            });

            if (response.ok) {
                closeModal('edit-policy-modal');
                await loadPolicies();
                alert('策略更新成功');
            } else {
                const res = await response.json();
                alert(res.detail || '更新失败');
            }
        } catch (error) {
            alert('更新失败: ' + error.message);
        }
    }

    async function togglePolicy(policyId, enabled) {
        try {
            await fetchWithAuth(`/api/v1/auth-policies/${policyId}`, {
                method: 'PUT',
                body: JSON.stringify({ enabled }),
            });
        } catch (error) {
            console.error('切换状态失败:', error);
        }
    }

    async function deletePolicy(policyId) {
        if (!confirm('确定要删除此策略吗？')) return;

        try {
            const response = await fetchWithAuth(`/api/v1/auth-policies/${policyId}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                await loadPolicies();
                alert('策略删除成功');
            } else {
                const data = await response.json();
                alert(data.detail || '删除失败');
            }
        } catch (error) {
            alert('删除失败: ' + error.message);
        }
    }
</script>
{% endblock %}
