{% extends "base.html" %}

{% block content %}
<div class="roles-page">
    <h1>角色管理</h1>

    <div class="card">
        <div class="card-header">
            <h2>角色列表</h2>
            <button class="btn btn-primary" onclick="showAddRoleModal()">+ 添加角色</button>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>角色名称</th>
                            <th>角色代码</th>
                            <th>权限数量</th>
                            <th>描述</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="roles-table">
                        <tr>
                            <td colspan="7" class="empty-state">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
            <h2>权限列表</h2>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>权限代码</th>
                            <th>权限名称</th>
                            <th>描述</th>
                        </tr>
                    </thead>
                    <tbody id="permissions-table">
                        <tr>
                            <td colspan="4" class="empty-state">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 添加角色模态框 -->
<div id="add-role-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>添加角色</h3>
            <button class="modal-close" onclick="closeModal('add-role-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="add-role-form">
                <div class="form-group">
                    <label for="new-role-name">角色名称</label>
                    <input type="text" id="new-role-name" required placeholder="如：管理员">
                </div>
                <div class="form-group">
                    <label for="new-role-code">角色代码</label>
                    <input type="text" id="new-role-code" required placeholder="如：admin">
                </div>
                <div class="form-group">
                    <label for="new-role-description">描述</label>
                    <textarea id="new-role-description" rows="2" style="width:100%;padding:0.5rem;"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('add-role-modal')">取消</button>
            <button class="btn btn-primary" onclick="addRole()">添加</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allRoles = [];
    let allPermissions = [];

    document.addEventListener('DOMContentLoaded', async () => {
        await loadRoles();
        await loadPermissions();
    });

    async function loadRoles() {
        try {
            const response = await fetchWithAuth('/api/v1/roles');
            if (response.ok) {
                allRoles = await response.json();
                renderRoles(allRoles);
            }
        } catch (error) {
            console.error('加载角色失败:', error);
        }
    }

    async function loadPermissions() {
        try {
            const response = await fetchWithAuth('/api/v1/permissions');
            if (response.ok) {
                allPermissions = await response.json();
                renderPermissions(allPermissions);
            }
        } catch (error) {
            console.error('加载权限失败:', error);
        }
    }

    function renderRoles(roles) {
        const tbody = document.getElementById('roles-table');

        if (roles.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">暂无角色</td></tr>';
            return;
        }

        tbody.innerHTML = roles.map(role => `
            <tr>
                <td>${role.id}</td>
                <td>${role.name}</td>
                <td><code>${role.code}</code></td>
                <td>${(role.permissions || []).length}</td>
                <td>${role.description || '-'}</td>
                <td>${formatTime(role.created_at)}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewRolePermissions(${role.id})">权限</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteRole(${role.id})">删除</button>
                </td>
            </tr>
        `).join('');
    }

    function renderPermissions(permissions) {
        const tbody = document.getElementById('permissions-table');

        if (permissions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="empty-state">暂无权限</td></tr>';
            return;
        }

        tbody.innerHTML = permissions.map(perm => `
            <tr>
                <td>${perm.id}</td>
                <td><code>${perm.code}</code></td>
                <td>${perm.name}</td>
                <td>${perm.description || '-'}</td>
            </tr>
        `).join('');
    }

    function showAddRoleModal() {
        document.getElementById('add-role-form').reset();
        document.getElementById('add-role-modal').classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    async function addRole() {
        const data = {
            name: document.getElementById('new-role-name').value,
            code: document.getElementById('new-role-code').value,
            description: document.getElementById('new-role-description').value,
        };

        try {
            const response = await fetchWithAuth('/api/v1/roles', {
                method: 'POST',
                body: JSON.stringify(data),
            });

            if (response.ok) {
                closeModal('add-role-modal');
                await loadRoles();
                alert('角色添加成功');
            } else {
                const res = await response.json();
                alert(res.detail || '添加失败');
            }
        } catch (error) {
            alert('添加失败: ' + error.message);
        }
    }

    async function deleteRole(roleId) {
        if (!confirm('确定要删除此角色吗？')) return;

        try {
            const response = await fetchWithAuth(`/api/v1/roles/${roleId}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                await loadRoles();
                alert('角色删除成功');
            } else {
                const data = await response.json();
                alert(data.detail || '删除失败');
            }
        } catch (error) {
            alert('删除失败: ' + error.message);
        }
    }

    function viewRolePermissions(roleId) {
        const role = allRoles.find(r => r.id === roleId);
        if (!role) return;

        const perms = (role.permissions || []).map(p => p.name || p.code).join('\n') || '暂无权限';
        alert(`角色 "${role.name}" 的权限:\n\n${perms}`);
    }

    function formatTime(timestamp) {
        if (!timestamp) return '-';
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN');
    }
</script>
{% endblock %}
